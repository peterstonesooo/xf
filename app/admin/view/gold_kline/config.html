<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">黄金K线API配置</h3>
            </div>
            <form class="form-horizontal" id="configForm">
                <div class="box-body">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">API Token <span class="text-danger">*</span></label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="api_token" 
                                   value="{$config.api_token ?? ''}" placeholder="请输入API Token（留空不修改）">
                            <span class="help-block"><i class="fa fa-info-circle"></i> 从 alltick.co 获取的API Token，留空不会清除已有配置</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">API地址</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="api_url" 
                                   value="{$config.api_url ?? ''}" placeholder="留空使用默认地址">
                            <span class="help-block">默认: https://quote.alltick.co/quote-b-api/kline，留空不会清除已有配置</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">黄金产品代码 <span class="text-danger">*</span></label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="gold_code" 
                                   value="{$config.gold_code ?? 'XAUCNH'}" placeholder="例如：XAUCNH">
                            <span class="help-block">黄金产品的交易代码，推荐：XAUCNH（自动转换为克计价）</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">价格类型</label>
                        <div class="col-sm-8">
                            <select class="form-control" name="price_type">
                                <option value="CNY" {$config.price_type == 'CNY' ? 'selected' : ''}>人民币/克</option>
                                <option value="USD" {$config.price_type == 'USD' ? 'selected' : ''}>美元/盎司</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">同步间隔（秒）</label>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" name="sync_interval" 
                                   value="{$config.sync_interval ?? '60'}" placeholder="60">
                            <span class="help-block">定时任务同步间隔时间，单位：秒</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">K线类型</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="kline_types" 
                                   value="{$config.kline_types ?? '8'}" placeholder="8">
                            <span class="help-block">需要同步的K线类型，多个用逗号分隔。1-1分钟, 2-5分钟, 3-15分钟, 4-30分钟, 5-1小时, 7-4小时, 8-1天, 9-1周, 10-1月</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">是否启用</label>
                        <div class="col-sm-8">
                            <div class="radio">
                                <label>
                                    <input type="radio" name="is_enabled" value="1" 
                                           {$config.is_enabled == '1' || !isset($config.is_enabled) ? 'checked' : ''}> 启用
                                </label>
                                <label style="margin-left: 20px;">
                                    <input type="radio" name="is_enabled" value="0" 
                                           {$config.is_enabled == '0' ? 'checked' : ''}> 禁用
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="box-footer">
                    <div class="col-sm-offset-2 col-sm-8">
                        <button type="button" class="btn btn-primary" onclick="saveConfig()">保存配置</button>
                        <button type="button" class="btn btn-default" onclick="testSync()">测试同步</button>
                        <a href="{:url('admin/GoldKline/index')}" class="btn btn-default">返回</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function saveConfig() {
        var formData = $('#configForm').serialize();
        $.post('{:url("admin/GoldKline/config")}', formData, function (res) {
            if (res.code == 1) {
                layer.msg(res.msg, {icon: 1});
            } else {
                layer.msg(res.msg, {icon: 2});
            }
        });
    }

    function testSync() {
        layer.confirm('确定执行测试同步吗？', function (index) {
            layer.close(index);
            var loadIndex = layer.load(2);
            $.post('{:url("admin/GoldKline/sync")}', {type: 'realtime', kline_type: 8, query_num: 2}, function (res) {
                layer.close(loadIndex);
                if (res.code == 1) {
                    layer.msg('测试成功：' + res.msg, {icon: 1, time: 3000});
                } else {
                    layer.msg('测试失败：' + res.msg, {icon: 2, time: 3000});
                }
            });
        });
    }
</script>

