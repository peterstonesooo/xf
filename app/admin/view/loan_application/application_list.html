<div class="search">
    <form class="form-inline">
        <input type="text" value="{$req['user_id']??''}" name="user_id" placeholder="搜索用户ID" class="form-control">
        <input type="text" value="{$req['phone']??''}" name="phone" placeholder="搜索手机号" class="form-control">
        <select name="status" class="form-control">
            <option value="">搜索状态</option>
            <?php foreach ($statusMap as $k => $v) { ?>
                <option <?php if (isset($req['status']) && $req['status'] == $k) {
                    echo 'selected = "selected"';
                } ?> value="{$k}">{$v}
                </option>
            <?php } ?>
        </select>
        <select name="product_id" class="form-control">
            <option value="">搜索产品</option>
            <?php foreach ($products as $product) { ?>
                <option <?php if (isset($req['product_id']) && $req['product_id'] == $product['id']) {
                    echo 'selected = "selected"';
                } ?> value="{$product['id']}">{$product['name']}
                </option>
            <?php } ?>
        </select>
        <input class="btn btn-flat btn-primary m_10" type="submit" value="搜索">
        <a href="{:url('admin/LoanApplication/exportApplications')}" class="btn btn-flat btn-success m_10">导出</a>
        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;共 {$data->total()} 条记录</span>
    </form>
</div>

<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header">
                <div class="box-body table-responsive no-padding">
                    <table class="table table-bordered table-hover table-striped">
                        <tbody>
                        <tr>
                            <th>ID</th>
                            <th>用户信息</th>
                            <th>产品信息</th>
                            <th>贷款金额</th>
                            <th>贷款期限</th>
                            <th>分期数</th>
                            <th>利息率</th>
                            <th>总利息</th>
                            <th>总金额</th>
                            <th>状态</th>
                            <th>申请时间</th>
                            <th>审核时间</th>
                            <th>操作</th>
                        </tr>
                        <?php foreach ($data as $k => $v) { ?>
                            <tr>
                                <td>{$v['id']}</td>
                                <td>
                                    用户ID：{$v['user_id']}<br>
                                    手机号：{$v['user']['phone']}<br>
                                    姓名：{$v['user']['realname']}
                                </td>
                                <td>
                                    产品：{$v['product']['name']}<br>
                                    梯度：{$v['gradient']['loan_days']}天/{$v['gradient']['installment_count']}期
                                </td>
                                <td>￥{$v['loan_amount']}</td>
                                <td>{$v['loan_days']}天</td>
                                <td>{$v['installment_count']}期</td>
                                <td>{$v['interest_rate']}%</td>
                                <td>￥{$v['total_interest']}</td>
                                <td>￥{$v['total_amount']}</td>
                                <td>
                                    <span class="label label-{if condition="$v['status'] eq 1"}warning{elseif condition="$v['status'] eq 2"}info{elseif condition="$v['status'] eq 3"}danger{elseif condition="$v['status'] eq 4"}success{else/}default{/if}">{$v['status_text']}</span>
                                </td>
                                <td>{$v['created_at']}</td>
                                <td>{$v['audit_time']}</td>
                                <td>
                                    <a href="{:url('admin/LoanApplication/applicationDetail', ['id' => $v['id']])}" class="btn btn-flat btn-info btn-xs">详情</a>
                                    {if condition="$v['status'] eq 1"}
                                    <button class="btn btn-flat btn-success btn-xs approve-btn" data-id="{$v['id']}">通过</button>
                                    <button class="btn btn-flat btn-danger btn-xs reject-btn" data-id="{$v['id']}">拒绝</button>
                                    {/if}
                                    {if condition="$v['status'] eq 2"}
                                    <button class="btn btn-flat btn-primary btn-xs disburse-btn" data-id="{$v['id']}">放款</button>
                                    {/if}
                                </td>
                            </tr>
                        <?php } ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 审核模态框 -->
<div class="modal fade" id="auditModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">审核申请</h4>
            </div>
            <div class="modal-body">
                <form id="audit-form">
                    <input type="hidden" id="audit-id" name="id">
                    <input type="hidden" id="audit-status" name="status">
                    <div class="form-group">
                        <label id="audit-label">审核备注</label>
                        <textarea class="form-control" name="audit_remark" rows="3" placeholder="请输入审核备注"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="submit-audit">确认</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 全选/取消全选
    $('#select-all').change(function() {
        $('.select-item').prop('checked', $(this).prop('checked'));
    });

    // 单个审核
    $('.approve-btn').click(function() {
        var id = $(this).data('id');
        $('#audit-id').val(id);
        $('#audit-status').val(2);
        $('.modal-title').text('审核通过');
        $('#audit-label').text('通过备注');
        $('textarea[name="audit_remark"]').attr('placeholder', '请输入通过备注（可选）');
        $('#submit-audit').removeClass('btn-danger').addClass('btn-success').text('确认通过');
        $('#auditModal').modal('show');
    });

    $('.reject-btn').click(function() {
        var id = $(this).data('id');
        $('#audit-id').val(id);
        $('#audit-status').val(3);
        $('.modal-title').text('审核拒绝');
        $('#audit-label').text('拒绝原因');
        $('textarea[name="audit_remark"]').attr('placeholder', '请输入拒绝原因（必填）');
        $('#submit-audit').removeClass('btn-success').addClass('btn-danger').text('确认拒绝');
        $('#auditModal').modal('show');
    });

    // 放款
    $('.disburse-btn').click(function() {
        var id = $(this).data('id');
        layer.confirm('确定要放款吗？', {icon: 3, title: '提示'}, function(index) {
            layer.close(index);
            $.post('{:url("admin/LoanApplication/disburseLoan")}', {id: id}, function(res) {
                if (res.code == 0) {
                    layer.msg('放款成功', {icon: 1, time: 2000}, function() {
                        location.reload();
                    });
                } else {
                    layer.msg(res.msg || '放款失败', {icon: 5, time: 3000});
                }
            });
        });
    });

    // 提交审核
    $('#submit-audit').click(function() {
        var status = $('#audit-status').val();
        var remark = $('textarea[name="audit_remark"]').val().trim();
        
        // 如果是拒绝且没有填写原因，提示用户
        if (status == 3 && !remark) {
            layer.msg('请填写拒绝原因', {icon: 5, time: 2000});
            return;
        }
        
        var formData = $('#audit-form').serialize();
        $.post('{:url("admin/LoanApplication/auditApplication")}', formData, function(res) {
            if (res.code == 0) {
                layer.msg('审核成功', {icon: 1, time: 2000}, function() {
                    $('#auditModal').modal('hide');
                    location.reload();
                });
            } else {
                layer.msg(res.msg || '操作失败', {icon: 5, time: 3000});
            }
        });
    });
});
</script>
