<div class="search">
    <form class="form-inline">
        <input type="text" value="{$req['user_id']??''}" name="user_id" placeholder="搜索用户ID" class="form-control">
        <input type="text" value="{$req['phone']??''}" name="phone" placeholder="搜索手机号" class="form-control">
        <input type="number" value="{$req['overdue_days_min']??''}" name="overdue_days_min" placeholder="最小逾期天数" class="form-control">
        <input type="number" value="{$req['overdue_days_max']??''}" name="overdue_days_max" placeholder="最大逾期天数" class="form-control">
        <input class="btn btn-flat btn-primary m_10" type="submit" value="搜索">
        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;共 {$data->total()} 条记录</span>
    </form>
</div>

<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header">
                <div class="box-body table-responsive no-padding">
                    <table class="table table-bordered table-hover table-striped">
                        <tbody>
                        <tr>
                            <th>ID</th>
                            <th>用户信息</th>
                            <th>申请信息</th>
                            <th>期数</th>
                            <th>到期日期</th>
                            <th>应还金额</th>
                            <th>逾期天数</th>
                            <th>逾期利息</th>
                            <th>总应还金额</th>
                            <th>操作</th>
                        </tr>
                        <?php foreach ($data as $k => $v) { ?>
                            <tr>
                                <td>{$v['id']}</td>
                                <td>
                                    用户ID：{$v['user_id']}<br>
                                    手机号：{$v['user']['phone']}<br>
                                    姓名：{$v['user']['realname']}
                                </td>
                                <td>
                                    申请ID：{$v['application_id']}<br>
                                    贷款金额：￥{$v['application']['loan_amount']}
                                </td>
                                <td>第{$v['period']}期</td>
                                <td>{$v['due_date']}</td>
                                <td>￥{$v['remaining_amount']}</td>
                                <td>
                                    <span class="label label-danger">{$v['overdue_days']}天</span>
                                </td>
                                <td>￥{$v['overdue_interest']}</td>
                                <td>￥{$v['remaining_amount'] + $v['overdue_interest']}</td>
                                <td>
                                    <a href="{:url('admin/LoanRepayment/showPlan', ['id' => $v['id']])}" class="btn btn-flat btn-info btn-xs">详情</a>
                                    <button class="btn btn-flat btn-primary btn-xs" onclick="manualRepay({$v['id']})">手动还款</button>
                                    <button class="btn btn-flat btn-warning btn-xs" onclick="sendReminder({$v['id']})">发送提醒</button>
                                </td>
                            </tr>
                        <?php } ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 手动还款模态框 -->
<div class="modal fade" id="repayModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">手动还款</h4>
            </div>
            <div class="modal-body">
                <form id="repay-form">
                    <input type="hidden" id="repay-plan-id" name="plan_id">
                    <div class="form-group">
                        <label>还款金额</label>
                        <input type="number" class="form-control" name="repayment_amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>钱包类型</label>
                        <select class="form-control" name="wallet_type" id="wallet-type" required>
                            <option value="">请选择钱包类型</option>
                            <option value="1">充值余额</option>
                            <option value="2">荣誉钱包</option>
                            <option value="5">惠民钱包</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>用户钱包余额</label>
                        <div id="wallet-balance" class="form-control-static">
                            请先选择钱包类型
                        </div>
                    </div>
                    <div class="form-group">
                        <label>备注</label>
                        <textarea class="form-control" name="remark" rows="3" placeholder="请输入备注"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="submit-repay">提交</button>
            </div>
        </div>
    </div>
</div>

<script>
var currentPlanId = null;
var userWalletBalances = {};

function manualRepay(planId) {
    currentPlanId = planId;
    $('#repay-plan-id').val(planId);
    
    // 获取用户钱包余额
    $.get('{:url("admin/LoanRepayment/getUserWalletBalances")}', {plan_id: planId}, function(res) {
        if (res.code == 0) {
            userWalletBalances = res.data;
            $('#repayModal').modal('show');
        } else {
            alert('获取用户钱包信息失败：' + res.msg);
        }
    });
}

function sendReminder(planId) {
    if (confirm('确定要发送逾期提醒吗？')) {
        $.post('{:url("admin/LoanRepayment/sendReminder")}', {plan_id: planId}, function(res) {
            if (res.code == 0) {
                alert('提醒发送成功');
            } else {
                alert(res.msg);
            }
        });
    }
}

$(document).ready(function() {
    // 钱包类型选择变化时更新余额显示
    $('#wallet-type').change(function() {
        var walletType = $(this).val();
        if (walletType && userWalletBalances[walletType]) {
            var balance = userWalletBalances[walletType].balance;
            var name = userWalletBalances[walletType].name;
            $('#wallet-balance').html(name + '：￥' + balance);
        } else {
            $('#wallet-balance').html('请先选择钱包类型');
        }
    });

    $('#submit-repay').click(function() {
        var planId = $('#repay-plan-id').val();
        var repaymentAmount = $('input[name="repayment_amount"]').val();
        var walletType = $('#wallet-type').val();
        var remark = $('textarea[name="remark"]').val();

        if (!repaymentAmount || repaymentAmount <= 0) {
            alert('请输入有效的还款金额');
            return;
        }

        if (!walletType) {
            alert('请选择钱包类型');
            return;
        }

        // 检查余额是否足够
        if (userWalletBalances[walletType] && parseFloat(userWalletBalances[walletType].balance) < parseFloat(repaymentAmount)) {
            alert('钱包余额不足，无法还款');
            return;
        }

        var formData = {
            plan_id: planId,
            repayment_amount: repaymentAmount,
            wallet_type: walletType,
            remark: remark
        };

        $.post('{:url("admin/LoanRepayment/manualRepay")}', formData, function(res) {
            if (res.code == 0) {
                alert('还款成功');
                $('#repayModal').modal('hide');
                location.reload();
            } else {
                alert('还款失败：' + res.msg);
            }
        });
    });
});
</script>
