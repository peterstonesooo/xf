<div class="search">
    <div class="alert alert-info">
        <strong>用户信息：</strong> {$user.realname} ({$user.phone})
        <a href="{:url('admin/User/userList')}" class="btn btn-default btn-sm pull-right">
            <i class="fa fa-arrow-left"></i> 返回用户列表
        </a>
    </div>
</div>

<!-- 团队概况 -->
<div class="row">
    <div class="col-md-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">团队概况</h3>
            </div>
            <div class="box-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="info-box bg-blue">
                            <span class="info-box-icon"><i class="fa fa-users"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">团队总人数</span>
                                <span class="info-box-number">{$teamData.team_total_count}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-box bg-green">
                            <span class="info-box-icon"><i class="fa fa-check-circle"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">团队实名人数</span>
                                <span class="info-box-number">{$teamData.team_real_name_count}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-box bg-yellow">
                            <span class="info-box-icon"><i class="fa fa-star"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">团队激活人数</span>
                                <span class="info-box-number">{$teamData.team_active_count}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 奖励发放表单 -->
<div class="row">
    <div class="col-md-12">
        <div class="box box-success">
            <div class="box-header with-border">
                <h3 class="box-title">奖励发放</h3>
            </div>
            <div class="box-body">
                <div class="alert alert-warning">
                    <strong>奖励规则：</strong>
                    <ul style="margin-bottom: 0;">
                        <li>阶段一奖励：每人发放 50 元</li>
                        <li>阶段二奖励：每人发放 100 元</li>
                        <li>阶段三奖励：每人发放 200 元</li>
                        <li>每个人每个阶段只能领取一次奖励</li>
                        <li>只对已激活的团队成员发放</li>
                    </ul>
                </div>
                
                <form id="rewardForm" class="form-horizontal">
                    <input type="hidden" name="user_id" value="{$user.id}">
                    
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fa fa-gift"></i> 一键发放团队奖励
                            </button>
                            <span class="help-block">系统将自动检查并发放给所有符合条件的团队成员</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 奖励发放记录 -->
<div class="row">
    <div class="col-md-12">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">奖励发放记录</h3>
            </div>
            <div class="box-body">
                {if condition="empty($rewardRecords)"}
                    <div class="text-center text-muted">
                        <i class="fa fa-info-circle"></i> 暂无奖励发放记录
                    </div>
                {else/}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>下级用户ID</th>
                                    <th>奖励级别</th>
                                    <th>奖励金额</th>
                                    <th>发放时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                {volist name="rewardRecords" id="record" key="index"}
                                <tr>
                                    <td>{$index}</td>
                                    <td>{$record.sub_user_id}</td>
                                    <td>
                                        <span class="label label-{if condition='$record.reward_level == 1'}info{elseif condition='$record.reward_level == 2'}warning{else/}danger{/if}">
                                            {$record.reward_type}
                                        </span>
                                    </td>
                                    <td class="text-success">￥{$record.reward_amount}</td>
                                    <td>{$record.created_at}</td>
                                </tr>
                                {/volist}
                            </tbody>
                        </table>
                    </div>
                {/if}
            </div>
        </div>
    </div>
</div>

<!-- 各级别团队详情 -->
<div class="row">
    <div class="col-md-4">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">阶段一团队</h3>
                <span class="label label-info">{$teamData.level_1.total_count}人</span>
            </div>
            <div class="box-body">
                <p><strong>实名人数：</strong>{$teamData.level_1.real_name_count}人</p>
                <p><strong>激活人数：</strong>{$teamData.level_1.active_count}人</p>
                <button type="button" class="btn btn-info btn-sm" onclick="showLevelMembers(1)">
                    <i class="fa fa-eye"></i> 查看成员
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="box box-warning">
            <div class="box-header with-border">
                <h3 class="box-title">阶段二团队</h3>
                <span class="label label-warning">{$teamData.level_2.total_count}人</span>
            </div>
            <div class="box-body">
                <p><strong>实名人数：</strong>{$teamData.level_2.real_name_count}人</p>
                <p><strong>激活人数：</strong>{$teamData.level_2.active_count}人</p>
                <button type="button" class="btn btn-warning btn-sm" onclick="showLevelMembers(2)">
                    <i class="fa fa-eye"></i> 查看成员
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="box box-danger">
            <div class="box-header with-border">
                <h3 class="box-title">阶段三团队</h3>
                <span class="label label-danger">{$teamData.level_3.total_count}人</span>
            </div>
            <div class="box-body">
                <p><strong>实名人数：</strong>{$teamData.level_3.real_name_count}人</p>
                <p><strong>激活人数：</strong>{$teamData.level_3.active_count}人</p>
                <button type="button" class="btn btn-danger btn-sm" onclick="showLevelMembers(3)">
                    <i class="fa fa-eye"></i> 查看成员
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 团队成员详情弹框 -->
<div class="modal fade" id="membersModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="membersModalTitle">团队成员详情</h4>
            </div>
            <div class="modal-body">
                <div id="membersTableContainer">
                    <!-- 成员列表将在这里显示 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 奖励发放表单提交
    $('#rewardForm').on('submit', function(e) {
        e.preventDefault();
        
        var formData = $(this).serialize();
        
        // 确认发放
        layer.confirm('确定要发放团队奖励吗？<br><br>系统将自动检查并发放给所有符合条件的团队成员，每个人每个阶段只能领取一次。', {
            icon: 3, 
            title: '确认发放',
            btn: ['确定发放', '取消']
        }, function(index) {
            layer.close(index);
            
            // 显示加载中
            var loadIndex = layer.load(1, {shade: [0.3, '#000']});
            
            $.post('{:url("admin/Reward/distributeReward")}', formData, function(res) {
                layer.close(loadIndex);
                
                if (res.code == 200) {
                    layer.msg('奖励发放成功！<br>共发放' + res.data.success_count + '人，总金额￥' + res.data.total_amount + '元', {
                        icon: 1, 
                        time: 3000
                    }, function() {
                        window.location.reload();
                    });
                } else {
                    layer.msg(res.msg, {icon: 2, time: 3000});
                }
            }).fail(function() {
                layer.close(loadIndex);
                layer.msg('发放失败，请重试', {icon: 2, time: 3000});
            });
        });
    });
});

// 显示指定级别的团队成员
function showLevelMembers(level) {
    var levelText = ['', '阶段一', '阶段二', '阶段三'][level];
    var teamData = {$teamData|json_encode|raw};
    var levelData = teamData['level_' + level];
    
    if (!levelData || levelData.members.length === 0) {
        layer.msg(levelText + '团队暂无成员', {icon: 1, time: 2000});
        return;
    }
    
    var html = '<table class="table table-bordered table-hover">';
    html += '<thead><tr><th>用户ID</th><th>手机号</th><th>姓名</th><th>实名状态</th><th>激活状态</th></tr></thead>';
    html += '<tbody>';
    
    levelData.members.forEach(function(member) {
        var realNameStatus = member.shiming_status == 1 ? 
            '<span class="label label-success">已实名</span>' : 
            '<span class="label label-default">未实名</span>';
        
        var activeStatus = member.activation_id ? 
            '<span class="label label-success">已激活</span>' : 
            '<span class="label label-default">未激活</span>';
        
        html += '<tr>';
        html += '<td>' + member.sub_user_id + '</td>';
        html += '<td>' + (member.phone || '-') + '</td>';
        html += '<td>' + (member.realname || '-') + '</td>';
        html += '<td>' + realNameStatus + '</td>';
        html += '<td>' + activeStatus + '</td>';
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    $('#membersModalTitle').text(levelText + '团队成员详情');
    $('#membersTableContainer').html(html);
    $('#membersModal').modal('show');
}
</script>
