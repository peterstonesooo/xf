<div class="search">
    <form class="form-inline">
        <input type="text" value="{$req['user_id']??''}" name="user_id" placeholder="搜索用户ID" class="form-control">
        <input type="text" value="{$req['up_user']??''}" name="up_user" placeholder="搜索上级用户ID/手机号"
               class="form-control">
        <input type="text" value="{$req['phone']??''}" name="phone" placeholder="搜索手机号" class="form-control">
        <input type="text" value="{$req['realname']??''}" name="realname" placeholder="搜索实名姓名" class="form-control">
        <select name="level" class="form-control">
            <option value="">搜索等级</option>
            <?php foreach (config('map.user')['level_map'] as $k => $v) { ?>
            <option <?php if (isset($req['level']) && $req['level'] !== '' && $req['level'] == $k) {
                    echo 'selected = "selected"';
                } ?> value="{$k}">{$v}
            </option>
            <?php } ?>
        </select>
        <select name="is_active" class="form-control">
            <option value="">搜索是否激活</option>
            <option <?php if (isset($req['is_active']) && $req['is_active'] !== '' && $req['is_active'] == 0) {
                echo 'selected = "selected"';
            } ?> value="0">未激活
            </option>
            <option <?php if (isset($req['is_active']) && $req['is_active'] !== '' && $req['is_active'] == 1) {
                echo 'selected = "selected"';
            } ?> value="1">已激活
            </option>
        </select>
        <input placeholder="开始时间" autocomplete="off" value="{$req['start_date']??''}" name="start_date" class="form-control layer-date" id="start">
        ～
        <input placeholder="结束时间" autocomplete="off" value="{$req['end_date']??''}" name="end_date" class="form-control layer-date" id="end">
        <input placeholder="激活时间" autocomplete="off" value="{$req['active_date']??''}" name="active_date" class="form-control layer-date" id="active_date">
        <input class="btn btn-flat btn-primary m_10" type="submit" value="搜索">
        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;共 {$count} 条记录</span>

        <a class="btn btn-flat btn-success m_10 f_r"
           href="{:url('admin/User/showBank',['user_id' => $req['user_id']])}"><i class="fa fa-plus m-r-10"></i>添 加</a>

    </form>
</div>

<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header">
                <div class="box-body table-responsive no-padding">
                    <table class="table table-bordered table-hover table-striped">
                        <tbody>
                        <tr>
                            <th>ID</th>
                            <th>姓名</th>
                            <th>银行名/账号</th>
                            <th>开户行</th>
                            <th>卡号</th>
                            <th>时间</th>
                            <th>操作</th>
                        </tr>
                        <?php foreach ($data as $k => $v) { ?>
                            <tr>
                                <td>{$v['id']}</td>
                                <td>{$v['name']}</td>
                                <td>
                                    <?php if($v['type'] == 0) { ?>
                                        {$v['bank_name']}
                                    <?php } elseif($v['type'] == 1) { ?>
                                        {$v['zhifubao']}
                                    <?php } elseif($v['type'] == 2) { ?>
                                        {$v['weixin']}
                                    <?php } ?>
                                </td>
                                
                                <td>{$v['bank_address']}</td>
                                <td>{$v['bank_sn']}</td>
                                <td>{$v['reg_date']}</td>
                                <td>
                                    <a {:auth_show_judge('User/bankedit')} onclick="editBank({$v['id']}, '{$v['name']}', '{$v['bank_name']}', '{$v['bank_address']}', '{$v['bank_sn']}')" class="btn btn-flat btn-xs btn-warning" href="#">修改</a>
                                    <a {:auth_show_judge('User/bankdel')} onclick="deluser({$v['id']})" class="btn btn-flat btn-xs btn-danger" href="#">删除</a>
                                </td>
                            </tr>
                        <?php } ?>
                        </tbody>
                    </table>
                </div>
                <div style="text-align:center;font-size: 14px;"><?php echo $data->render(); ?></div>
            </div>
        </div>
    </div>
</div>

<!-- 修改银行卡模态框 -->
<div class="modal fade" id="editBankModal" tabindex="-1" role="dialog" aria-labelledby="editBankModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="editBankModalLabel">修改银行卡信息</h4>
            </div>
            <form id="editBankForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_bank_id" name="id">
                    <div class="form-group">
                        <label for="edit_name">姓名</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_bank_name">银行名称</label>
                        <input type="text" class="form-control" id="edit_bank_name" name="bank_name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_bank_address">开户行</label>
                        <input type="text" class="form-control" id="edit_bank_address" name="bank_address" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_bank_sn">卡号</label>
                        <input type="text" class="form-control" id="edit_bank_sn" name="bank_sn" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存修改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(function () {
        //日期范围限制
        var start = {
            elem: '#start',
            format: 'yyyy-MM-dd',
        };
        var end = {
            elem: '#end',
            format: 'yyyy-MM-dd',
        };
        var active_date = {
            elem: '#active_date',
            format: 'yyyy-MM-dd',
        };
        laydate.render(start);
        laydate.render(end);
        laydate.render(active_date);
    });
    
    // 修改银行卡函数
    function editBank(id, name, bank_name, bank_address, bank_sn) {
        // 填充表单数据
        $('#edit_bank_id').val(id);
        $('#edit_name').val(name);
        $('#edit_bank_name').val(bank_name);
        $('#edit_bank_address').val(bank_address);
        $('#edit_bank_sn').val(bank_sn);
        
        // 显示模态框
        $('#editBankModal').modal('show');
    }
    
    // 表单提交处理
    $(document).ready(function() {
        $('#editBankForm').on('submit', function(e) {
            e.preventDefault();
            
            var formData = $(this).serialize();
            
            $.ajax({
                url: '{:url("admin/User/updateBank")}',
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: function(response) {
                    if (response.code == 200) {
                        layer.msg('修改成功', {icon: 1, time: 2000}, function() {
                            $('#editBankModal').modal('hide');
                            window.location.reload();
                        });
                    } else {
                        layer.msg(response.msg, {icon: 2, time: 2000});
                    }
                },
                error: function() {
                    layer.msg('修改失败，请重试', {icon: 2, time: 2000});
                }
            });
        });
    });
    
    function changeUser(id, value)
    {
        //确认框
        layer.confirm('确定操作吗', {icon: 3, title: '提示'}, function (index) {
            layer.close(index);
            $.post('{:url("bankedit")}', {"id": id, "status": value}, function (res) {
                layer.msg(res.msg, {icon: 7, time: 2500, offset: '80px'}, function (){
                    window.location.reload();
                });
            });
        });
    }
    function deluser(id)
    {
        //确认框
        layer.confirm('确定操作吗', {icon: 3, title: '提示'}, function (index) {
            layer.close(index);
            $.post('{:url("bankdel")}', {"id": id}, function (res) {
                layer.msg(res.msg, {icon: 7, time: 2500, offset: '80px'}, function (){
                    window.location.reload();
                });
            });
        });
    }
</script>
<style>
    th{
        font-size: 14px;
    }
</style>
